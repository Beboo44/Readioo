@using Readioo.Business.DataTransferObjects.Book
@using Readioo.Business.DataTransferObjects.Genre

@model IEnumerable<BookDto>

@{
    ViewData["Title"] = "Browse Books";
    var genres = ViewBag.Genres as IEnumerable<GenreDto>;

    string ResolveImagePath(string imagePath)
    {
        if (string.IsNullOrEmpty(imagePath)) return null;
        if (imagePath.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return imagePath;
        if (imagePath.StartsWith("~") || imagePath.StartsWith("/")) return Url.Content(imagePath);
        return Url.Content("~/" + imagePath);
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browse Books - Readioo</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="~/css/globalandbook.css">
    <!-- Reusing MyBooks CSS for consistent layout -->
    <link rel="stylesheet" href="~/css/my_books.css">
    <link rel="stylesheet" href="~/css/browse.css" />

    <style>
        /* Layout overrides to match My Books structure */
        .main-layout {
            display: flex;
            flex-direction: row;
            gap: 40px;
            align-items: flex-start;
            margin-top: 10px; /* Reduced from 20px */
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
        }

        .main-content {
            flex-grow: 1;
            width: 100%;
        }

        /* Sidebar Styling */
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
        }

        .filter-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

            .filter-list li {
                padding: 10px 15px;
                cursor: pointer;
                border-radius: 6px;
                color: #555;
                transition: background 0.2s, color 0.2s;
                margin-bottom: 5px;
            }

                .filter-list li:hover {
                    background-color: #f0f2f5;
                    color: #333;
                }

                .filter-list li.active {
                    background-color: #e9f5f0;
                    color: #146c43;
                    font-weight: bold;
                }

        /* Book Grid Styling */
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 25px;
        }

        .book-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            transition: transform 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

            .book-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }

        .book-cover {
            height: 300px;
            overflow: hidden;
        }

            .book-cover img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .book-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .book-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .book-author {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .book-rating {
            margin-bottom: 10px;
        }

        .book-actions {
            margin-top: auto;
        }

        .shelf-btn {
            width: 100%;
            background-color: #e9f5f0;
            color: #146c43;
            border: none;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.2s;
        }

            .shelf-btn:hover {
                background-color: #d1e7dd;
            }
    </style>
</head>
<body>

    <!-- Page Container -->
    <div class="wrap" id="browse-page">

        <!-- Page Header -->
        <!-- 4. Fixed Title -->
        <header class="page-header container mt-3 mb-3">
            <div class="page-meta">
                <div class="page-title" style="font-size: 2rem; font-weight: bold;">Browse Books</div>
                <div class="page-subtitle text-muted">Discover your next great read</div>
            </div>
        </header>

        <!-- 1. Fixed Layout Structure (Sidebar Left, Content Right) -->
        <div class="main-layout container mb-5">

            <!-- Sidebar Filters -->
            <aside class="sidebar">
                <div class="card">
                    <h4>Filter by Genre</h4>
                    <ul class="filter-list" id="genreFilter">
                        <!-- 'All' Option -->
                        <li data-genre="all" class="active" onclick="filterBooks('all', this)">All Genres</li>

                        <!-- 2. Dynamic Side Table -->
                        @if (genres != null && genres.Any())
                        {
                            foreach (var genre in genres)
                            {
                                <li data-genre="@genre.GenreName" onclick="filterBooks('@genre.GenreName', this)">
                                    @genre.GenreName
                                </li>
                            }
                        }
                        else
                        {
                            <li class="text-muted">No genres found.</li>
                        }
                    </ul>
                </div>
            </aside>

            <!-- Book Grid (Center Content) -->
            <section class="main-content">
                <div class="book-grid" id="bookGrid">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            var imgUrl = ResolveImagePath(item.BookImage);
                            // Join genres with a specific separator for JS parsing
                            var genreString = item.BookGenres != null ? string.Join(",", item.BookGenres) : "";

                            <!-- 3. Store genres in data attribute for filtering -->
                            <div class="book-card-wrapper" data-genres="@genreString">
                                <div class="book-card">
                                    <div class="book-cover">
                                        <a asp-controller="Book" asp-action="Details" asp-route-id="@item.BookId">
                                            <img src="@(string.IsNullOrEmpty(imgUrl) ? "https://placehold.co/200x300?text=No+Cover" : imgUrl)"
                                                 alt="@item.Title" />
                                        </a>
                                    </div>

                                    <div class="book-info">
                                        <div class="book-title" title="@item.Title">
                                            <a asp-controller="Book" asp-action="Details" asp-route-id="@item.BookId" class="text-decoration-none text-dark">
                                                @item.Title
                                            </a>
                                        </div>

                                        <div class="book-author">@item.AuthorName</div>

                                        <!-- Rating -->
                                        <div class="book-rating">
                                            @if (item.Rate > 0)
                                            {
                                                <span class="text-warning">
                                                    <i class="fas fa-star"></i> @item.Rate.ToString("0.0")
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted small">Not rated</span>
                                            }
                                        </div>

                                        <div class="book-actions">
                                            <form asp-controller="Book" asp-action="AddToShelf" method="post">
                                                <input type="hidden" name="bookId" value="@item.BookId" />
                                                <input type="hidden" name="shelfName" value="Want to Read" />
                                                <button type="submit" class="shelf-btn">
                                                    Want to Read
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12 text-center text-muted py-5">
                            <h4>No books found.</h4>
                        </div>
                    }
                </div>

                <div id="noResultsMsg" class="text-center text-muted py-5 d-none">
                    <h4>No books found for this genre.</h4>
                </div>
            </section>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/browse.js"></script>

    <!-- JavaScript for Filtering -->
    <script>
        function filterBooks(selectedGenre, element) {
            console.log('Filtering by genre:', selectedGenre);

            // 1. Update Active Class in Sidebar
            document.querySelectorAll('#genreFilter li').forEach(li => li.classList.remove('active'));
            element.classList.add('active');

            // 2. Filter Books
            const allBooks = document.querySelectorAll('.book-card-wrapper');
            let visibleCount = 0;

            allBooks.forEach(wrapper => {
                // Get the comma-separated genres string from the book
                const bookGenresRaw = wrapper.getAttribute('data-genres');
                console.log('Book genres raw:', bookGenresRaw);

                // Convert to array and trim whitespace from each genre
                const bookGenres = bookGenresRaw ? bookGenresRaw.split(',').map(g => g.trim()) : [];
                console.log('Book genres array:', bookGenres);

                if (selectedGenre === 'all') {
                    wrapper.style.display = 'block';
                    visibleCount++;
                } else {
                    // Check if the array contains the exact genre name (case-insensitive)
                    const hasGenre = bookGenres.some(g => g.toLowerCase() === selectedGenre.toLowerCase());

                    if (hasGenre) {
                        wrapper.style.display = 'block';
                        visibleCount++;
                    } else {
                        wrapper.style.display = 'none';
                    }
                }
            });

            console.log('Visible books:', visibleCount);

            // 3. Show/Hide "No Results" message
            const noResults = document.getElementById('noResultsMsg');
            const bookGrid = document.getElementById('bookGrid');

            if (visibleCount === 0) {
                noResults.classList.remove('d-none');
                bookGrid.style.display = 'none';
            } else {
                noResults.classList.add('d-none');
                bookGrid.style.display = 'grid';
            }
        }
    </script>
</body>
</html>